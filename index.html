<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ëá™ÂàÜÂ∞ÇÁî®„ÅÆ„Ç≥„Éº„ÉâË≠úÁÆ°ÁêÜ„Ç¢„Éó„É™ - „Ç≠„ÉºÂ§âÊõ¥„ÄÅÁ∑®ÈõÜ„ÄÅ‰øùÂ≠ò„ÅåÁ∞°Âçò„Å´„Åß„Åç„Åæ„Åô">
    <meta name="theme-color" content="#9333ea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="My Chord Sheets">
    
    <title>My Chord Sheets - „Ç≥„Éº„ÉâË≠úÁÆ°ÁêÜ</title>
    
    <!-- PWAÁî®„Éû„Éã„Éï„Çß„Çπ„Éà -->
    <link rel="manifest" href="manifest.json">
    
    <!-- „Ç¢„Ç§„Ç≥„É≥ -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Lucide Icon„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„ÅÆ„É©„ÉÉ„Éë„Éº
        const Icon = ({ icon, className = '' }) => {
            const ref = React.useRef(null);
            
            React.useEffect(() => {
                if (ref.current) {
                    // data-lucideÂ±ûÊÄß„ÇíË®≠ÂÆö
                    ref.current.setAttribute('data-lucide', icon);
                    // Lucide„Ç¢„Ç§„Ç≥„É≥„ÇíÂàùÊúüÂåñ
                    if (window.lucide && window.lucide.createIcons) {
                        window.lucide.createIcons({ icons: ref.current });
                    }
                }
            }, [icon]);
            
            return <i ref={ref} className={className}></i>;
        };

        const ChordManager = () => {
            const [songs, setSongs] = useState([]);
            const [currentSong, setCurrentSong] = useState(null);
            const [isEditing, setIsEditing] = useState(false);
            const [editForm, setEditForm] = useState({ title: '', artist: '', originalKey: 'C', lyrics: '', referenceUrl: '' });
            const [transposeSteps, setTransposeSteps] = useState(0);
            const [showSongList, setShowSongList] = useState(true);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [showInstallPrompt, setShowInstallPrompt] = useState(false);
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            
            // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´Èñ¢ÈÄ£
            const [isAutoScrolling, setIsAutoScrolling] = useState(false);
            const [scrollSpeed, setScrollSpeed] = useState(1);
            const scrollIntervalRef = React.useRef(null);

            const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const noteAliases = { 'Db': 'C#', 'Eb': 'D#', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#' };

            useEffect(() => {
                loadSongs();
                
                // „Ç™„É≥„É©„Ç§„É≥/„Ç™„Éï„É©„Ç§„É≥Áä∂ÊÖã„ÇíÁõ£Ë¶ñ
                const handleOnline = () => {
                    setIsOnline(true);
                    console.log('„Ç™„É≥„É©„Ç§„É≥„Å´„Å™„Çä„Åæ„Åó„Åü');
                };
                const handleOffline = () => {
                    setIsOnline(false);
                    console.log('„Ç™„Éï„É©„Ç§„É≥„Å´„Å™„Çä„Åæ„Åó„Åü');
                };
                
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                
                // PWA„Ç§„É≥„Çπ„Éà„Éº„É´„Éó„É≠„É≥„Éó„Éà„ÇíÁõ£Ë¶ñ
                const handleBeforeInstall = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                    setShowInstallPrompt(true);
                };
                
                window.addEventListener('beforeinstallprompt', handleBeforeInstall);
                
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                    window.removeEventListener('beforeinstallprompt', handleBeforeInstall);
                    // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                    if (scrollIntervalRef.current) {
                        clearInterval(scrollIntervalRef.current);
                    }
                };
            }, []);
            
            const handleInstallClick = async () => {
                if (!deferredPrompt) return;
                
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log('PWA„Åå„Ç§„É≥„Çπ„Éà„Éº„É´„Åï„Çå„Åæ„Åó„Åü');
                }
                
                setDeferredPrompt(null);
                setShowInstallPrompt(false);
            };
            
            // ÁèæÂú®„ÅÆ„Ç≠„ÉºÂ§âÊõ¥„ÇíÊ•ΩÊõ≤„Å´‰øùÂ≠ò
            const saveCurrentTranspose = () => {
                if (!currentSong) return;
                
                const updatedSong = {
                    ...currentSong,
                    savedTranspose: transposeSteps,
                    updatedAt: new Date().toISOString()
                };
                
                const allSongs = songs.map(s => s.id === updatedSong.id ? updatedSong : s);
                localStorage.setItem('chordSheets', JSON.stringify(allSongs));
                setSongs(allSongs);
                setCurrentSong(updatedSong);
                alert(`„Ç≠„Éº ${getTransposedKey(currentSong.originalKey, transposeSteps)} „Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü`);
            };
            
            // Ê•ΩÊõ≤ÈÅ∏ÊäûÊôÇ„Å´‰øùÂ≠ò„Åï„Çå„Åü„Ç≠„Éº„ÇíÈÅ©Áî®
            const selectSong = (song) => {
                setCurrentSong(song);
                setIsEditing(false);
                setTransposeSteps(song.savedTranspose || 0);
                setShowSongList(false);
                stopAutoScroll(); // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´ÂÅúÊ≠¢
            };
            
            // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´ÈñãÂßã
            const startAutoScroll = () => {
                if (scrollIntervalRef.current) {
                    clearInterval(scrollIntervalRef.current);
                }
                
                setIsAutoScrolling(true);
                scrollIntervalRef.current = setInterval(() => {
                    window.scrollBy({
                        top: scrollSpeed,
                        behavior: 'auto'
                    });
                }, 16); // Á¥Ñ60fps
            };
            
            // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´ÂÅúÊ≠¢
            const stopAutoScroll = () => {
                if (scrollIntervalRef.current) {
                    clearInterval(scrollIntervalRef.current);
                    scrollIntervalRef.current = null;
                }
                setIsAutoScrolling(false);
            };
            
            // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´„ÅÆ„Éà„Ç∞„É´
            const toggleAutoScroll = () => {
                if (isAutoScrolling) {
                    stopAutoScroll();
                } else {
                    startAutoScroll();
                }
            };
            
            // PDFÂá∫Âäõ
            const exportToPDF = () => {
                if (!currentSong) return;
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // „Éï„Ç©„É≥„ÉàË®≠ÂÆöÔºàÊó•Êú¨Ë™ûÂØæÂøúÔºâ
                doc.setFont('helvetica');
                
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 15;
                const contentWidth = pageWidth - (margin * 2);
                const lineHeight = 6;
                let yPosition = margin;
                
                // „Çø„Ç§„Éà„É´ÈÉ®ÂàÜ
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(currentSong.title, margin, yPosition);
                yPosition += 10;
                
                // „Ç¢„Éº„ÉÜ„Ç£„Çπ„Éà„Å®„Ç≠„ÉºÊÉÖÂ†±
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                const artistText = currentSong.artist || '‰∏çÊòé';
                const keyInfo = transposeSteps !== 0 
                    ? `Key: ${currentSong.originalKey} ‚Üí ${currentKey} (${transposeSteps > 0 ? '+' : ''}${transposeSteps})`
                    : `Key: ${currentSong.originalKey}`;
                doc.text(`${artistText} | ${keyInfo}`, margin, yPosition);
                yPosition += 8;
                
                // Âå∫Âàá„ÇäÁ∑ö
                doc.setDrawColor(147, 51, 234); // purple-600
                doc.setLineWidth(0.5);
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 8;
                
                // Ê≠åË©û„Å®„Ç≥„Éº„Éâ„ÇíÂá¶ÁêÜ
                const lyrics = currentSong.lyrics;
                const lines = lyrics.split('\n');
                
                doc.setFontSize(11);
                doc.setFont('courier', 'normal'); // Á≠âÂπÖ„Éï„Ç©„É≥„Éà
                
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i];
                    
                    // „Éö„Éº„Ç∏„Éñ„É¨„Éº„ÇØË®òÂè∑„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                    if (line.trim() === '---' || line.trim() === '===') {
                        doc.addPage();
                        yPosition = margin;
                        
                        // Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏„Å´„ÇÇ„Éò„ÉÉ„ÉÄ„ÉºÊÉÖÂ†±„ÇíËøΩÂä†
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`${currentSong.title} - ${artistText} (${keyInfo})`, margin, yPosition);
                        yPosition += 8;
                        doc.setFontSize(11);
                        doc.setFont('courier', 'normal');
                        continue;
                    }
                    
                    // „Éö„Éº„Ç∏„ÅÆÁµÇ„Çè„Çä„Å´Ëøë„Å•„ÅÑ„Åü„ÇâËá™ÂãïÊîπ„Éö„Éº„Ç∏
                    if (yPosition > pageHeight - margin - 10) {
                        doc.addPage();
                        yPosition = margin;
                        
                        // „Éò„ÉÉ„ÉÄ„ÉºÊÉÖÂ†±
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`${currentSong.title} - ${artistText} (${keyInfo})`, margin, yPosition);
                        yPosition += 8;
                        doc.setFontSize(11);
                        doc.setFont('courier', 'normal');
                    }
                    
                    // „Ç≥„Éº„Éâ„ÇíÁßªË™ø„Åó„Å¶Âá¶ÁêÜ
                    const processedLine = line.replace(/\[([A-G][#b]?[^\]]*)\]/g, (match, chord) => {
                        return `[${transposeChord(chord, transposeSteps)}]`;
                    });
                    
                    // „ÉÜ„Ç≠„Çπ„Éà„ÇíË°å„Å´ÂàÜÂâ≤ÔºàÈï∑„ÅÑË°å„ÅÆÂá¶ÁêÜÔºâ
                    const maxCharsPerLine = 110; // Ê®™Âêë„Åç„Å™„ÅÆ„ÅßÈï∑„ÇÅ„Å´
                    if (processedLine.length > maxCharsPerLine) {
                        const words = processedLine.split(' ');
                        let currentLine = '';
                        
                        for (const word of words) {
                            if ((currentLine + ' ' + word).length > maxCharsPerLine) {
                                if (currentLine) {
                                    doc.text(currentLine, margin, yPosition);
                                    yPosition += lineHeight;
                                }
                                currentLine = word;
                            } else {
                                currentLine += (currentLine ? ' ' : '') + word;
                            }
                        }
                        
                        if (currentLine) {
                            doc.text(currentLine, margin, yPosition);
                            yPosition += lineHeight;
                        }
                    } else {
                        doc.text(processedLine, margin, yPosition);
                        yPosition += lineHeight;
                    }
                }
                
                // „Éï„ÉÉ„Çø„ÉºÔºà„Éö„Éº„Ç∏Áï™Âè∑Ôºâ
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Page ${i} of ${pageCount}`, pageWidth - margin - 20, pageHeight - 5);
                }
                
                // PDF„Çí‰øùÂ≠ò
                const filename = `${currentSong.title.replace(/[^\w\s]/gi, '')}_${currentKey}.pdf`;
                doc.save(filename);
            };

            const loadSongs = () => {
                try {
                    const savedSongs = localStorage.getItem('chordSheets');
                    if (savedSongs) {
                        setSongs(JSON.parse(savedSongs).sort((a, b) => 
                            new Date(b.updatedAt) - new Date(a.updatedAt)
                        ));
                    }
                } catch (error) {
                    console.log('Ê•ΩÊõ≤„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                }
            };

            const saveSong = () => {
                if (!editForm.title.trim()) {
                    alert('Êõ≤Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                const songData = {
                    id: currentSong?.id || Date.now().toString(),
                    title: editForm.title,
                    artist: editForm.artist,
                    originalKey: editForm.originalKey,
                    lyrics: editForm.lyrics,
                    referenceUrl: editForm.referenceUrl,
                    savedTranspose: currentSong?.savedTranspose || 0,
                    updatedAt: new Date().toISOString()
                };

                try {
                    const allSongs = songs.filter(s => s.id !== songData.id);
                    allSongs.unshift(songData);
                    localStorage.setItem('chordSheets', JSON.stringify(allSongs));
                    setSongs(allSongs);
                    setCurrentSong(songData);
                    setIsEditing(false);
                    setTransposeSteps(songData.savedTranspose);
                } catch (error) {
                    alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            };

            const deleteSong = (id) => {
                if (!confirm('„Åì„ÅÆÊõ≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
                
                try {
                    const filteredSongs = songs.filter(s => s.id !== id);
                    localStorage.setItem('chordSheets', JSON.stringify(filteredSongs));
                    setSongs(filteredSongs);
                    if (currentSong?.id === id) {
                        setCurrentSong(null);
                    }
                } catch (error) {
                    alert('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            };

            const startEdit = (song = null) => {
                if (song) {
                    setEditForm({
                        title: song.title,
                        artist: song.artist,
                        originalKey: song.originalKey,
                        lyrics: song.lyrics,
                        referenceUrl: song.referenceUrl || ''
                    });
                    setCurrentSong(song);
                } else {
                    setEditForm({ title: '', artist: '', originalKey: 'C', lyrics: '', referenceUrl: '' });
                    setCurrentSong(null);
                }
                setIsEditing(true);
                setShowSongList(false);
            };

            const cancelEdit = () => {
                setIsEditing(false);
                if (!currentSong) {
                    setShowSongList(true);
                }
                stopAutoScroll(); // Á∑®ÈõÜ„Ç≠„É£„É≥„Çª„É´ÊôÇ„Å´Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´ÂÅúÊ≠¢
            };

            const transposeChord = (chord, steps) => {
                const match = chord.match(/^([A-G][#b]?)(.*)/);
                if (!match) return chord;

                let [, root, suffix] = match;
                
                if (noteAliases[root]) {
                    root = noteAliases[root];
                }

                const index = notes.indexOf(root);
                if (index === -1) return chord;

                const newIndex = (index + steps + 12) % 12;
                return notes[newIndex] + suffix;
            };

            const processLyrics = (lyrics, steps) => {
                return lyrics.split('\n').map((line, lineIndex) => {
                    // „Éö„Éº„Ç∏„Éñ„É¨„Éº„ÇØË®òÂè∑„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                    if (line.trim() === '---' || line.trim() === '===') {
                        return { 
                            lineIndex, 
                            isPageBreak: true,
                            parts: [{ type: 'text', content: line }] 
                        };
                    }
                    
                    const parts = [];
                    let lastIndex = 0;
                    const regex = /\[([A-G][#b]?[^\]]*)\]/g;
                    let match;

                    while ((match = regex.exec(line)) !== null) {
                        if (match.index > lastIndex) {
                            parts.push({
                                type: 'text',
                                content: line.slice(lastIndex, match.index)
                            });
                        }
                        parts.push({
                            type: 'chord',
                            content: transposeChord(match[1], steps)
                        });
                        lastIndex = regex.lastIndex;
                    }

                    if (lastIndex < line.length) {
                        parts.push({
                            type: 'text',
                            content: line.slice(lastIndex)
                        });
                    }

                    return { lineIndex, parts: parts.length > 0 ? parts : [{ type: 'text', content: line }] };
                });
            };

            const getTransposedKey = (originalKey, steps) => {
                const index = notes.indexOf(originalKey);
                if (index === -1) return originalKey;
                return notes[(index + steps + 12) % 12];
            };

            const displayedLines = currentSong ? processLyrics(currentSong.lyrics, transposeSteps) : [];
            const currentKey = currentSong ? getTransposedKey(currentSong.originalKey, transposeSteps) : 'C';

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 p-4">
                    <div className="max-w-6xl mx-auto">
                        {/* „Ç™„Éï„É©„Ç§„É≥Áä∂ÊÖãË°®Á§∫ */}
                        {!isOnline && (
                            <div className="bg-yellow-500 text-white px-4 py-2 rounded-lg mb-4 flex items-center justify-center gap-2">
                                <span className="font-bold">üì° „Ç™„Éï„É©„Ç§„É≥„É¢„Éº„Éâ</span>
                                <span className="text-sm">- „Éá„Éº„Çø„ÅØ‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅÂêåÊúü„ÅØ„Ç™„É≥„É©„Ç§„É≥ÊôÇ„Å´Ë°å„Çè„Çå„Åæ„Åô</span>
                            </div>
                        )}
                        
                        {/* „Ç§„É≥„Çπ„Éà„Éº„É´‰øÉÈÄ≤„Éê„Éä„Éº */}
                        {showInstallPrompt && (
                            <div className="bg-purple-600 text-white px-4 py-3 rounded-lg mb-4 flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <Icon icon="Download" className="w-6 h-6" />
                                    <div>
                                        <div className="font-bold">„Ç¢„Éó„É™„Å®„Åó„Å¶„Ç§„É≥„Çπ„Éà„Éº„É´</div>
                                        <div className="text-sm text-purple-100">„Ç™„Éï„É©„Ç§„É≥„Åß„ÇÇ‰Ωø„Åà„Çã„Çà„ÅÜ„Å´„Å™„Çä„Åæ„ÅôÔºÅ</div>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={handleInstallClick}
                                        className="bg-white text-purple-600 px-4 py-2 rounded-lg font-bold hover:bg-purple-50 transition-colors"
                                    >
                                        „Ç§„É≥„Çπ„Éà„Éº„É´
                                    </button>
                                    <button
                                        onClick={() => setShowInstallPrompt(false)}
                                        className="text-white hover:bg-purple-700 px-3 py-2 rounded-lg transition-colors"
                                    >
                                        ‚úï
                                    </button>
                                </div>
                            </div>
                        )}
                        
                        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <Icon icon="Music" className="w-8 h-8 text-purple-600" />
                                    <div>
                                        <h1 className="text-3xl font-bold text-gray-800">My Chord Sheets</h1>
                                        {isOnline ? (
                                            <span className="text-xs text-green-600 flex items-center gap-1">
                                                <span className="w-2 h-2 bg-green-600 rounded-full"></span>
                                                „Ç™„É≥„É©„Ç§„É≥
                                            </span>
                                        ) : (
                                            <span className="text-xs text-yellow-600 flex items-center gap-1">
                                                <span className="w-2 h-2 bg-yellow-600 rounded-full"></span>
                                                „Ç™„Éï„É©„Ç§„É≥
                                            </span>
                                        )}
                                    </div>
                                </div>
                                <button
                                    onClick={() => startEdit()}
                                    className="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors"
                                >
                                    <Icon icon="Plus" className="w-5 h-5" />
                                    Êñ∞Ë¶è‰ΩúÊàê
                                </button>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {showSongList && (
                                <div className="lg:col-span-1">
                                    <div className="bg-white rounded-lg shadow-md p-4">
                                        <h2 className="text-xl font-bold text-gray-800 mb-4">Ê•ΩÊõ≤„É™„Çπ„Éà</h2>
                                        <div className="space-y-2 max-h-[600px] overflow-y-auto">
                                            {songs.length === 0 ? (
                                                <p className="text-gray-500 text-center py-8">„Åæ„Å†Ê•ΩÊõ≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                                            ) : (
                                                songs.map(song => (
                                                    <div
                                                        key={song.id}
                                                        className={`p-3 rounded-lg border-2 cursor-pointer transition-all ${
                                                            currentSong?.id === song.id
                                                                ? 'border-purple-500 bg-purple-50'
                                                                : 'border-gray-200 hover:border-purple-300'
                                                        }`}
                                                        onClick={() => selectSong(song)}
                                                    >
                                                        <div className="flex items-start justify-between">
                                                            <div className="flex-1">
                                                                <div className="font-bold text-gray-800">{song.title}</div>
                                                                {song.artist && (
                                                                    <div className="text-sm text-gray-600">{song.artist}</div>
                                                                )}
                                                                {song.referenceUrl && (
                                                                    <div className="flex items-center gap-1 text-xs text-blue-600 mt-1">
                                                                        <Icon icon="ExternalLink" className="w-3 h-3" />
                                                                        ÂèÇÁÖßURLÊúâ„Çä
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                        <div className="flex items-center justify-between mt-2">
                                                            <div className="flex items-center gap-2">
                                                                <span className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">
                                                                    Key: {song.originalKey}
                                                                </span>
                                                                {song.savedTranspose !== undefined && song.savedTranspose !== 0 && (
                                                                    <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">
                                                                        ‰øùÂ≠ò: {getTransposedKey(song.originalKey, song.savedTranspose)}
                                                                    </span>
                                                                )}
                                                            </div>
                                                            <div className="flex gap-1">
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        startEdit(song);
                                                                    }}
                                                                    className="p-1 text-blue-600 hover:bg-blue-50 rounded"
                                                                >
                                                                    <Icon icon="Edit2" className="w-4 h-4" />
                                                                </button>
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        deleteSong(song.id);
                                                                    }}
                                                                    className="p-1 text-red-600 hover:bg-red-50 rounded"
                                                                >
                                                                    <Icon icon="Trash2" className="w-4 h-4" />
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div className={showSongList ? 'lg:col-span-2' : 'lg:col-span-3'}>
                                {isEditing ? (
                                    <div className="bg-white rounded-lg shadow-md p-6">
                                        <div className="flex items-center justify-between mb-6">
                                            <h2 className="text-2xl font-bold text-gray-800">
                                                {currentSong ? 'Ê•ΩÊõ≤„ÇíÁ∑®ÈõÜ' : 'Êñ∞Ë¶èÊ•ΩÊõ≤‰ΩúÊàê'}
                                            </h2>
                                            <button onClick={cancelEdit} className="text-gray-600 hover:text-gray-800">
                                                <Icon icon="X" className="w-6 h-6" />
                                            </button>
                                        </div>
                                        
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Êõ≤Âêç *</label>
                                                <input
                                                    type="text"
                                                    value={editForm.title}
                                                    onChange={(e) => setEditForm({ ...editForm, title: e.target.value })}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                    placeholder="Êõ≤Âêç„ÇíÂÖ•Âäõ"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">„Ç¢„Éº„ÉÜ„Ç£„Çπ„Éà</label>
                                                <input
                                                    type="text"
                                                    value={editForm.artist}
                                                    onChange={(e) => setEditForm({ ...editForm, artist: e.target.value })}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                    placeholder="„Ç¢„Éº„ÉÜ„Ç£„Çπ„ÉàÂêç„ÇíÂÖ•Âäõ"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">ÂèÇÁÖßURLÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ</label>
                                                <div className="text-sm text-gray-600 mb-2">
                                                    U-FRET„ÄÅChordWiki „Å™„Å©„ÅÆÂèÇÁÖßURL„Çí‰øùÂ≠ò„Åß„Åç„Åæ„Åô
                                                </div>
                                                <input
                                                    type="url"
                                                    value={editForm.referenceUrl}
                                                    onChange={(e) => setEditForm({ ...editForm, referenceUrl: e.target.value })}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                    placeholder="https://www.ufret.jp/... „Åæ„Åü„ÅØ https://ja.chordwiki.org/..."
                                                />
                                                {editForm.referenceUrl && (
                                                    <a
                                                        href={editForm.referenceUrl}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        className="inline-flex items-center gap-1 text-sm text-blue-600 hover:text-blue-700 mt-2"
                                                    >
                                                        <Icon icon="ExternalLink" className="w-4 h-4" />
                                                        „É™„É≥„ÇØ„ÇíÈñã„Åè
                                                    </a>
                                                )}
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">„Ç™„É™„Ç∏„Éä„É´„Ç≠„Éº</label>
                                                <select
                                                    value={editForm.originalKey}
                                                    onChange={(e) => setEditForm({ ...editForm, originalKey: e.target.value })}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                >
                                                    {notes.map(note => (
                                                        <option key={note} value={note}>{note}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Ê≠åË©û„Å®„Ç≥„Éº„Éâ</label>
                                                <div className="text-sm text-gray-600 mb-2">
                                                    <div className="mb-1">üìù „Ç≥„Éº„Éâ„ÅØ [C] [Am] [G7] „ÅÆ„Çà„ÅÜ„Å´ [ ] „ÅßÂõ≤„Çì„Åß„Åè„Å†„Åï„ÅÑ</div>
                                                    <div className="bg-blue-50 border border-blue-200 rounded p-2 mt-2">
                                                        <strong>üìÑ PDFÂç∞Âà∑Áî®„ÅÆ„Éö„Éº„Ç∏Âå∫Âàá„ÇäÔºö</strong>
                                                        <div className="mt-1">ÊîπË°å„Åó„Å¶ <code className="bg-blue-100 px-2 py-0.5 rounded">---</code> „Åæ„Åü„ÅØ <code className="bg-blue-100 px-2 py-0.5 rounded">===</code> „Å®ÂÖ•Âäõ„Åô„Çã„Å®„ÄÅPDFÂá∫ÂäõÊôÇ„Å´„Åù„Åì„ÅßÊîπ„Éö„Éº„Ç∏„Åï„Çå„Åæ„Åô</div>
                                                    </div>
                                                </div>
                                                <textarea
                                                    value={editForm.lyrics}
                                                    onChange={(e) => setEditForm({ ...editForm, lyrics: e.target.value })}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent font-mono"
                                                    rows={20}
                                                    placeholder="[C]Âêõ„Å´‰ºö„Åà„Åü [Am]Êó•„Åã„Çâ&#10;[F]ÂÉï„ÅÆ‰∏ñÁïå„ÅØ [G]Â§â„Çè„Å£„Åü&#10;&#10;---&#10;&#10;[C]2Áï™„ÅÆÊ≠åË©û..."
                                                />
                                            </div>

                                            <div className="flex gap-3">
                                                <button
                                                    onClick={saveSong}
                                                    className="flex-1 flex items-center justify-center gap-2 bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors"
                                                >
                                                    <Icon icon="Save" className="w-5 h-5" />
                                                    ‰øùÂ≠ò
                                                </button>
                                                <button
                                                    onClick={cancelEdit}
                                                    className="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                                                >
                                                    „Ç≠„É£„É≥„Çª„É´
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ) : currentSong ? (
                                    <div className="bg-white rounded-lg shadow-md p-6">
                                        <div className="flex items-start justify-between mb-6">
                                            <div className="flex-1">
                                                <h2 className="text-3xl font-bold text-gray-800">{currentSong.title}</h2>
                                                {currentSong.artist && (
                                                    <p className="text-lg text-gray-600 mt-1">{currentSong.artist}</p>
                                                )}
                                                {currentSong.referenceUrl && (
                                                    <a
                                                        href={currentSong.referenceUrl}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        className="inline-flex items-center gap-2 text-sm text-blue-600 hover:text-blue-700 mt-2 bg-blue-50 px-3 py-1 rounded-lg"
                                                    >
                                                        <Icon icon="ExternalLink" className="w-4 h-4" />
                                                        ÂèÇÁÖßÂÖÉ„ÇíÈñã„Åè
                                                    </a>
                                                )}
                                            </div>
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => setShowSongList(!showSongList)}
                                                    className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                                                >
                                                    {showSongList ? '„É™„Çπ„Éà„ÇíÈö†„Åô' : '„É™„Çπ„Éà„ÇíË°®Á§∫'}
                                                </button>
                                                <button
                                                    onClick={exportToPDF}
                                                    className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"
                                                    title="PDF„Åß‰øùÂ≠ò„ÉªÂç∞Âà∑"
                                                >
                                                    <Icon icon="Printer" className="w-4 h-4" />
                                                    PDFÂá∫Âäõ
                                                </button>
                                                <button
                                                    onClick={() => startEdit(currentSong)}
                                                    className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                                                >
                                                    <Icon icon="Edit2" className="w-4 h-4" />
                                                    Á∑®ÈõÜ
                                                </button>
                                            </div>
                                        </div>

                                        <div className="bg-purple-50 rounded-lg p-4 mb-6">
                                            <div className="flex items-center justify-between flex-wrap gap-4">
                                                <div className="flex items-center gap-4">
                                                    <span className="text-sm font-medium text-gray-700">
                                                        „Ç™„É™„Ç∏„Éä„É´„Ç≠„Éº: {currentSong.originalKey}
                                                    </span>
                                                    <div className="h-4 w-px bg-gray-300" />
                                                    <span className="text-sm font-medium text-gray-700">
                                                        ÁèæÂú®„ÅÆ„Ç≠„Éº: <span className="text-purple-700 text-lg font-bold">{currentKey}</span>
                                                    </span>
                                                    {transposeSteps !== 0 && (
                                                        <span className="text-xs text-purple-600">
                                                            ({transposeSteps > 0 ? '+' : ''}{transposeSteps})
                                                        </span>
                                                    )}
                                                    {currentSong.savedTranspose !== undefined && currentSong.savedTranspose !== 0 && (
                                                        <div className="h-4 w-px bg-gray-300" />
                                                    )}
                                                    {currentSong.savedTranspose !== undefined && currentSong.savedTranspose !== 0 && (
                                                        <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">
                                                            ‰øùÂ≠òÊ∏à: {getTransposedKey(currentSong.originalKey, currentSong.savedTranspose)}
                                                        </span>
                                                    )}
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <button
                                                        onClick={() => setTransposeSteps(Math.max(transposeSteps - 1, -11))}
                                                        disabled={transposeSteps === -11}
                                                        className="p-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                                    >
                                                        <Icon icon="ChevronDown" className="w-5 h-5" />
                                                    </button>
                                                    <button
                                                        onClick={() => setTransposeSteps(0)}
                                                        disabled={transposeSteps === 0}
                                                        className="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-sm font-medium"
                                                    >
                                                        „É™„Çª„ÉÉ„Éà
                                                    </button>
                                                    <button
                                                        onClick={() => setTransposeSteps(Math.min(transposeSteps + 1, 11))}
                                                        disabled={transposeSteps === 11}
                                                        className="p-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                                    >
                                                        <Icon icon="ChevronUp" className="w-5 h-5" />
                                                    </button>
                                                    <div className="h-8 w-px bg-gray-300 mx-1" />
                                                    <button
                                                        onClick={saveCurrentTranspose}
                                                        className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium"
                                                        title="„Åì„ÅÆ„Ç≠„Éº„Çí‰øùÂ≠ò„Åô„Çã„Å®„ÄÅÊ¨°ÂõûÈñã„ÅÑ„Åü„Å®„Åç„Å´„Åì„ÅÆ„Ç≠„Éº„ÅßË°®Á§∫„Åï„Çå„Åæ„Åô"
                                                    >
                                                        <Icon icon="Save" className="w-4 h-4" />
                                                        „Åì„ÅÆ„Ç≠„Éº„Çí‰øùÂ≠ò
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´„Ç≥„É≥„Éà„É≠„Éº„É´ */}
                                        <div className="bg-blue-50 rounded-lg p-4 mb-6">
                                            <div className="flex items-center justify-between flex-wrap gap-4">
                                                <div className="flex items-center gap-3">
                                                    <span className="text-sm font-medium text-gray-700">Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´</span>
                                                    <button
                                                        onClick={toggleAutoScroll}
                                                        className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-colors ${
                                                            isAutoScrolling
                                                                ? 'bg-red-600 text-white hover:bg-red-700'
                                                                : 'bg-green-600 text-white hover:bg-green-700'
                                                        }`}
                                                    >
                                                        {isAutoScrolling ? (
                                                            <>
                                                                <Icon icon="Pause" className="w-4 h-4" />
                                                                ÂÅúÊ≠¢
                                                            </>
                                                        ) : (
                                                            <>
                                                                <Icon icon="Play" className="w-4 h-4" />
                                                                ÈñãÂßã
                                                            </>
                                                        )}
                                                    </button>
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    <span className="text-sm font-medium text-gray-700">ÈÄüÂ∫¶:</span>
                                                    <button
                                                        onClick={() => setScrollSpeed(Math.max(0.5, scrollSpeed - 0.5))}
                                                        disabled={scrollSpeed <= 0.5}
                                                        className="px-3 py-1 bg-white border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                                    >
                                                        <Icon icon="Minus" className="w-4 h-4" />
                                                    </button>
                                                    <span className="text-base font-bold text-blue-700 min-w-[60px] text-center">
                                                        {scrollSpeed.toFixed(1)}x
                                                    </span>
                                                    <button
                                                        onClick={() => setScrollSpeed(Math.min(5, scrollSpeed + 0.5))}
                                                        disabled={scrollSpeed >= 5}
                                                        className="px-3 py-1 bg-white border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                                    >
                                                        <Icon icon="Plus" className="w-4 h-4" />
                                                    </button>
                                                    <div className="flex gap-1 ml-2">
                                                        {[0.5, 1, 2, 3].map(speed => (
                                                            <button
                                                                key={speed}
                                                                onClick={() => setScrollSpeed(speed)}
                                                                className={`px-2 py-1 text-xs rounded ${
                                                                    scrollSpeed === speed
                                                                        ? 'bg-blue-600 text-white'
                                                                        : 'bg-white border border-gray-300 hover:bg-gray-50'
                                                                }`}
                                                            >
                                                                {speed}x
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-gray-50 rounded-lg p-6">
                                            <div className="font-mono text-base leading-relaxed whitespace-pre-wrap">
                                                {displayedLines.map(({ lineIndex, parts, isPageBreak }) => (
                                                    isPageBreak ? (
                                                        <div key={lineIndex} className="my-4 flex items-center">
                                                            <div className="flex-1 border-t-2 border-dashed border-green-400"></div>
                                                            <span className="px-3 text-sm text-green-600 font-bold">üìÑ „Éö„Éº„Ç∏Âå∫Âàá„Çä</span>
                                                            <div className="flex-1 border-t-2 border-dashed border-green-400"></div>
                                                        </div>
                                                    ) : (
                                                        <div key={lineIndex} className="min-h-[1.5em]">
                                                            {parts.map((part, partIndex) => (
                                                                part.type === 'chord' ? (
                                                                    <span
                                                                        key={partIndex}
                                                                        className="text-purple-700 font-bold bg-purple-100 px-1 rounded"
                                                                    >
                                                                        {part.content}
                                                                    </span>
                                                                ) : (
                                                                    <span key={partIndex} className="text-gray-800">
                                                                        {part.content}
                                                                    </span>
                                                                )
                                                            ))}
                                                        </div>
                                                    )
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="bg-white rounded-lg shadow-md p-12 text-center">
                                        <Icon icon="Music" className="w-16 h-16 text-purple-300 mx-auto mb-4" />
                                        <h3 className="text-xl font-bold text-gray-800 mb-2">Ê•ΩÊõ≤„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
                                        <p className="text-gray-600">
                                            Â∑¶„ÅÆ„É™„Çπ„Éà„Åã„ÇâÊ•ΩÊõ≤„ÇíÈÅ∏„Å∂„Åã„ÄÅÊñ∞Ë¶è‰ΩúÊàê„Éú„Çø„É≥„ÅßÊñ∞„Åó„ÅÑ„Ç≥„Éº„ÉâË≠ú„Çí‰ΩúÊàê„Åß„Åç„Åæ„Åô
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<ChordManager />, document.getElementById('root'));
    </script>

    <!-- Service WorkerÁôªÈå≤ -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service WorkerÁôªÈå≤ÊàêÂäü - „Ç™„Éï„É©„Ç§„É≥ÂØæÂøúÂÆå‰∫ÜÔºÅ', registration);
                        
                        // Êõ¥Êñ∞„ÉÅ„Çß„ÉÉ„ÇØ
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'activated') {
                                    console.log('üîÑ Êñ∞„Éê„Éº„Ç∏„Éß„É≥„ÅåÂà©Áî®ÂèØËÉΩ„Åß„Åô');
                                    // ÂøÖË¶Å„Å´Âøú„Åò„Å¶„É™„É≠„Éº„Éâ‰øÉÈÄ≤
                                    if (confirm('Êñ∞„Åó„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„ÅåÂà©Áî®ÂèØËÉΩ„Åß„Åô„ÄÇÊõ¥Êñ∞„Åó„Åæ„Åô„ÅãÔºü')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(err => {
                        console.log('‚ùå Service WorkerÁôªÈå≤Â§±Êïó:', err);
                    });
                
                // „Ç™„Éï„É©„Ç§„É≥ÊôÇ„ÅÆÂá¶ÁêÜ
                window.addEventListener('offline', () => {
                    console.log('üì° „Ç™„Éï„É©„Ç§„É≥„Å´„Å™„Çä„Åæ„Åó„Åü - „Ç≠„É£„ÉÉ„Ç∑„É•„Åã„Çâ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åô');
                });
                
                window.addEventListener('online', () => {
                    console.log('üì° „Ç™„É≥„É©„Ç§„É≥„Å´Êàª„Çä„Åæ„Åó„Åü');
                });
            });
        } else {
            console.log('‚ö†Ô∏è „Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØService Worker„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì');
        }
    </script>
</body>
</html>
