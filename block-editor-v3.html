<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Éñ„É≠„ÉÉ„ÇØÂºè„Ç≥„Éº„ÉâË≠ú v3 - URLË™≠„ÅøËæº„Åø</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; padding-bottom: 80px; }
        .container { max-width: 100%; padding: 12px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 16px; margin: -12px -12px 16px -12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .header h1 { font-size: 20px; font-weight: bold; }
        .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
        .card-title { font-size: 18px; font-weight: bold; margin-bottom: 12px; color: #333; }
        .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .tab { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .tab-inactive { background: #e5e7eb; color: #6b7280; }
        .tab-chord { background: #3b82f6; color: white; }
        .tab-lyric { background: #f59e0b; color: white; }
        .tab-url { background: #8b5cf6; color: white; }
        .input-group { margin-bottom: 16px; }
        .label { display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px; }
        .input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; }
        .input:focus { outline: none; border-color: #3b82f6; }
        .textarea { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; min-height: 120px; resize: vertical; font-family: 'Courier New', monospace; }
        .select { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; background: white; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:active { background: #2563eb; }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:active { background: #d97706; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:active { background: #059669; }
        .btn-purple { background: #8b5cf6; color: white; }
        .btn-purple:active { background: #7c3aed; }
        .btn-purple:disabled { background: #9ca3af; cursor: not-allowed; }
        .btn-small { padding: 8px 12px; font-size: 14px; width: auto; display: inline-block; margin: 4px; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:active { background: #dc2626; }
        .key-selector { display: flex; gap: 8px; align-items: center; }
        .key-note { flex: 1; }
        .key-type { display: flex; gap: 8px; }
        .key-type-btn { flex: 1; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; font-weight: 600; cursor: pointer; }
        .key-type-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        .block-item { background: white; border: 2px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 8px; display: flex; align-items: flex-start; gap: 12px; }
        .block-checkbox { width: 24px; height: 24px; margin-top: 4px; cursor: pointer; }
        .block-content { flex: 1; }
        .block-chord { border-left: 4px solid #3b82f6; background: #eff6ff; }
        .block-lyric { border-left: 4px solid #f59e0b; background: #fffbeb; }
        .block-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .block-type { display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 600; color: #6b7280; }
        .block-controls { display: flex; gap: 8px; }
        .icon-btn { width: 32px; height: 32px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; background: #f3f4f6; color: #6b7280; }
        .icon-btn:active { background: #e5e7eb; }
        .icon-btn-danger { background: #fee2e2; color: #dc2626; }
        .insert-position { background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px; padding: 12px; margin-bottom: 16px; max-height: 200px; overflow-y: auto; }
        .insert-position-item { padding: 10px; margin-bottom: 8px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .insert-position-item:active { background: #f3f4f6; }
        .insert-position-item.selected { background: #dbeafe; border-color: #3b82f6; }
        .preview { background: #f9fafb; border-radius: 8px; padding: 16px; min-height: 150px; }
        .preview-chord { color: #3b82f6; font-weight: bold; margin-bottom: 4px; }
        .preview-lyric { margin-bottom: 4px; line-height: 1.6; }
        .empty-state { text-align: center; padding: 40px 20px; color: #9ca3af; }
        .badge { display: inline-block; background: #e5e7eb; color: #6b7280; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .hint { font-size: 13px; color: #6b7280; margin-top: 8px; line-height: 1.5; }
        .selection-controls { position: sticky; top: 0; background: white; padding: 12px; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 5; }
        .char-box { display: inline-block; padding: 4px 6px; margin: 2px; border: 2px solid #e5e7eb; border-radius: 4px; cursor: pointer; min-width: 24px; text-align: center; }
        .char-box.selected { background: #3b82f6; color: white; border-color: #3b82f6; }
        .import-preview { background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px; padding: 12px; margin-top: 12px; max-height: 300px; overflow-y: auto; }
        .import-preview-item { padding: 8px; margin-bottom: 4px; border-radius: 4px; }
        .import-preview-chord { background: #dbeafe; color: #1e40af; font-weight: bold; }
        .import-preview-lyric { background: #fef3c7; color: #78350f; }
        .loading { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 20px; color: #6b7280; }
        .spinner { width: 20px; height: 20px; border: 3px solid #e5e7eb; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-box { background: #fee2e2; border: 2px solid #ef4444; color: #991b1b; padding: 12px; border-radius: 8px; margin-top: 12px; font-size: 14px; }
        .url-input-row { display: flex; gap: 8px; }
        .url-input-row .input { flex: 1; }
        .url-input-row .btn { width: auto; padding: 12px 20px; white-space: nowrap; }
        .debug-info { background: #f3f4f6; border: 2px solid #d1d5db; border-radius: 8px; padding: 12px; margin-top: 12px; font-size: 12px; font-family: monospace; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState } = React;

        const BlockEditor = () => {
            const [blocks, setBlocks] = useState([]);
            const [activeTab, setActiveTab] = useState('url');
            const [songKey, setSongKey] = useState('C');
            const [keyType, setKeyType] = useState('major');
            
            const [lyricInput, setLyricInput] = useState('');
            const [lyricSize, setLyricSize] = useState(20);
            
            const [chordInput, setChordInput] = useState('');
            const [chordSize, setChordSize] = useState(16);
            const [insertPosition, setInsertPosition] = useState(null);
            
            const [urlInput, setUrlInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [loadError, setLoadError] = useState('');
            const [importPreview, setImportPreview] = useState([]);
            const [debugInfo, setDebugInfo] = useState('');
            
            const [selectedBlocks, setSelectedBlocks] = useState([]);
            const [selectedChars, setSelectedChars] = useState([]);

            // „Ç≥„Éº„ÉâÂà§ÂÆöÔºà„Çà„ÇäÂé≥ÂØÜ„Å´Ôºâ
            const isChordLine = (line) => {
                const trimmed = line.trim();
                if (!trimmed) return false;
                if (trimmed.length > 50) return false; // Èï∑„Åô„Åé„ÇãË°å„ÅØÊ≠åË©û
                
                // Êó•Êú¨Ë™û„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åü„ÇâÊ≠åË©û
                if (/[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/.test(trimmed)) return false;
                
                // „Ç≥„Éº„Éâ„Éë„Çø„Éº„É≥
                const chordPattern = /^[A-G][#b‚ôØ‚ô≠]?(?:m|maj|min|sus|dim|aug|add|M|6|7|9|11|13)*(?:\/[A-G][#b‚ôØ‚ô≠]?)?(\s+[A-G][#b‚ôØ‚ô≠]?(?:m|maj|min|sus|dim|aug|add|M|6|7|9|11|13)*(?:\/[A-G][#b‚ôØ‚ô≠]?)?)*$/;
                return chordPattern.test(trimmed);
            };

            // URL„Åã„Çâ„Ç≥„Éº„ÉâË≠ú„ÇíÂèñÂæó
            const fetchFromUrl = async () => {
                if (!urlInput.trim()) {
                    alert('URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                setIsLoading(true);
                setLoadError('');
                setImportPreview([]);
                setDebugInfo('Ë™≠„ÅøËæº„ÅøÈñãÂßã...\n');

                // Ë§áÊï∞„ÅÆCORS„Éó„É≠„Ç≠„Ç∑
                const proxies = [
                    { name: 'AllOrigins', url: `https://api.allorigins.win/raw?url=${encodeURIComponent(urlInput)}` },
                    { name: 'CORS.SH', url: `https://cors.sh/${urlInput}` },
                    { name: 'ThingProxy', url: `https://thingproxy.freeboard.io/fetch/${urlInput}` }
                ];

                for (const proxy of proxies) {
                    try {
                        setDebugInfo(prev => prev + `\n${proxy.name}„ÇíË©¶Ë°å‰∏≠...`);
                        
                        const response = await fetch(proxy.url, {
                            headers: proxy.name === 'CORS.SH' ? { 'x-cors-api-key': 'temp_4e2f3c8a1d9b5f7e6a0c2d8e9f1a3b5c' } : {}
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }

                        const html = await response.text();
                        setDebugInfo(prev => prev + `\n‚úì ${proxy.name}ÊàêÂäüÔºÅHTML„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü`);

                        // HTML„Çí„Éë„Éº„Çπ
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        
                        // ÊäΩÂá∫„ÇíË©¶„Åø„Çã
                        let extracted = extractFromUfret(doc);
                        
                        if (extracted.length === 0) {
                            setDebugInfo(prev => prev + '\nU-FRETÂΩ¢Âºè„ÅßÊäΩÂá∫Â§±Êïó„ÄÅÊ±éÁî®„Éë„Éº„Çπ„ÇíË©¶Ë°å...');
                            extracted = extractGeneric(doc);
                        }

                        if (extracted.length === 0) {
                            throw new Error('„Ç≥„Éº„ÉâË≠ú„ÇíÊäΩÂá∫„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                        }

                        setDebugInfo(prev => prev + `\n‚úì ${extracted.length}Ë°å„ÇíÊäΩÂá∫„Åó„Åæ„Åó„ÅüÔºÅ`);
                        setImportPreview(extracted);
                        setIsLoading(false);
                        return;

                    } catch (error) {
                        setDebugInfo(prev => prev + `\n‚úó ${proxy.name}Â§±Êïó: ${error.message}`);
                        continue;
                    }
                }

                // „Åô„Åπ„Å¶Â§±Êïó
                setLoadError('„Åô„Åπ„Å¶„ÅÆ„Éó„É≠„Ç≠„Ç∑„ÅßË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n\nÊâãÂãï„ÅßÊ≠åË©û„Å®„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                setIsLoading(false);
            };

            // U-FRETÂΩ¢Âºè„ÅÆÊäΩÂá∫
            const extractFromUfret = (doc) => {
                const results = [];
                
                // <pre>„Çø„Ç∞„ÇíÊé¢„Åô
                const preElements = doc.querySelectorAll('pre, code, [class*="chord"], [class*="lyric"]');
                
                preElements.forEach(element => {
                    const text = element.textContent || element.innerText;
                    const lines = text.split('\n');
                    
                    lines.forEach(line => {
                        const trimmed = line.trim();
                        if (!trimmed || trimmed.length < 1) return;
                        
                        if (isChordLine(trimmed)) {
                            results.push({
                                type: 'chord',
                                content: trimmed,
                                fontSize: chordSize
                            });
                        } else if (trimmed.length > 0 && trimmed.length < 100) {
                            results.push({
                                type: 'lyric',
                                content: trimmed,
                                fontSize: lyricSize,
                                charSizes: trimmed.split('').map(() => lyricSize)
                            });
                        }
                    });
                });

                return results;
            };

            // Ê±éÁî®ÁöÑ„Å™ÊäΩÂá∫
            const extractGeneric = (doc) => {
                const results = [];
                
                // body„Åã„Çâ„ÉÜ„Ç≠„Çπ„Éà„ÇíÂèñÂæó
                const bodyText = doc.body ? doc.body.textContent : '';
                const lines = bodyText.split('\n');
                
                let validLines = 0;
                
                lines.forEach(line => {
                    const trimmed = line.trim();
                    
                    // Á©∫Ë°å„ÄÅÁü≠„Åô„Åé„Çã„ÄÅÈï∑„Åô„Åé„ÇãË°å„Çí„Çπ„Ç≠„ÉÉ„Éó
                    if (!trimmed || trimmed.length < 1 || trimmed.length > 100) return;
                    
                    // HTML„Çø„Ç∞„Å£„ÅΩ„ÅÑ„ÇÇ„ÅÆ„Çí„Çπ„Ç≠„ÉÉ„Éó
                    if (/<[^>]+>/.test(trimmed)) return;
                    
                    // URL„ÄÅ„É°„Éº„É´„Å™„Å©„Çí„Çπ„Ç≠„ÉÉ„Éó
                    if (/^(https?:\/\/|www\.|@)/.test(trimmed)) return;
                    
                    validLines++;
                    
                    if (isChordLine(trimmed)) {
                        results.push({
                            type: 'chord',
                            content: trimmed,
                            fontSize: chordSize
                        });
                    } else {
                        results.push({
                            type: 'lyric',
                            content: trimmed,
                            fontSize: lyricSize,
                            charSizes: trimmed.split('').map(() => lyricSize)
                        });
                    }
                    
                    // 100Ë°å‰ª•‰∏äÂèñÂæó„Åó„Åü„ÇâÂÅúÊ≠¢
                    if (validLines >= 100) return;
                });

                return results;
            };

            // Âèñ„ÇäËæº„ÅøÂÆüË°å
            const executeImport = () => {
                if (importPreview.length === 0) {
                    alert('Âèñ„ÇäËæº„ÇÄ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                    return;
                }

                const newBlocks = importPreview.map((item, idx) => ({
                    ...item,
                    id: Date.now() + idx
                }));

                setBlocks([...blocks, ...newBlocks]);
                setImportPreview([]);
                setUrlInput('');
                setDebugInfo('');
                alert(`${newBlocks.length}ÂÄã„ÅÆ„Éñ„É≠„ÉÉ„ÇØ„ÇíËøΩÂä†„Åó„Åæ„Åó„ÅüÔºÅ`);
            };

            const addLyric = () => {
                if (!lyricInput.trim()) return;
                const lines = lyricInput.split('\n').filter(line => line.trim());
                const newBlocks = lines.map((line, idx) => ({
                    id: Date.now() + idx,
                    type: 'lyric',
                    content: line,
                    fontSize: lyricSize,
                    charSizes: line.split('').map(() => lyricSize)
                }));
                setBlocks([...blocks, ...newBlocks]);
                setLyricInput('');
            };

            const addChord = () => {
                if (!chordInput.trim() || insertPosition === null) {
                    alert('„Ç≥„Éº„Éâ„Å®ÊåøÂÖ•‰ΩçÁΩÆ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                const lines = chordInput.split('\n').filter(line => line.trim());
                const newChordBlocks = lines.map((line, idx) => ({
                    id: Date.now() + idx,
                    type: 'chord',
                    content: line.trim(),
                    fontSize: chordSize
                }));

                const newBlocks = [...blocks];
                let insertIndex = insertPosition.type === 'after' ? insertPosition.index + 1 : insertPosition.index;
                newBlocks.splice(insertIndex, 0, ...newChordBlocks);
                setBlocks(newBlocks);
                setChordInput('');
                setInsertPosition(null);
            };

            const deleteBlock = (id) => {
                setBlocks(blocks.filter(b => b.id !== id));
                setSelectedBlocks(selectedBlocks.filter(sid => sid !== id));
            };

            const deleteSelectedBlocks = () => {
                if (selectedBlocks.length === 0) return;
                if (!confirm(`${selectedBlocks.length}ÂÄã„ÅÆ„Éñ„É≠„ÉÉ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;
                setBlocks(blocks.filter(b => !selectedBlocks.includes(b.id)));
                setSelectedBlocks([]);
            };

            const toggleBlockSelection = (id) => {
                if (selectedBlocks.includes(id)) {
                    setSelectedBlocks(selectedBlocks.filter(sid => sid !== id));
                } else {
                    setSelectedBlocks([...selectedBlocks, id]);
                }
            };

            const toggleSelectAll = () => {
                if (selectedBlocks.length === blocks.length) {
                    setSelectedBlocks([]);
                } else {
                    setSelectedBlocks(blocks.map(b => b.id));
                }
            };

            const moveSelectedBlocksUp = () => {
                if (selectedBlocks.length === 0) return;
                const selectedIndices = blocks.map((b, idx) => selectedBlocks.includes(b.id) ? idx : -1).filter(idx => idx !== -1).sort((a, b) => a - b);
                if (selectedIndices[0] === 0) return;
                const newBlocks = [...blocks];
                selectedIndices.forEach(idx => {
                    [newBlocks[idx], newBlocks[idx - 1]] = [newBlocks[idx - 1], newBlocks[idx]];
                });
                setBlocks(newBlocks);
            };

            const moveSelectedBlocksDown = () => {
                if (selectedBlocks.length === 0) return;
                const selectedIndices = blocks.map((b, idx) => selectedBlocks.includes(b.id) ? idx : -1).filter(idx => idx !== -1).sort((a, b) => b - a);
                if (selectedIndices[0] === blocks.length - 1) return;
                const newBlocks = [...blocks];
                selectedIndices.forEach(idx => {
                    [newBlocks[idx], newBlocks[idx + 1]] = [newBlocks[idx + 1], newBlocks[idx]];
                });
                setBlocks(newBlocks);
            };

            const toggleCharSelection = (blockId, charIndex) => {
                const key = `${blockId}-${charIndex}`;
                if (selectedChars.includes(key)) {
                    setSelectedChars(selectedChars.filter(k => k !== key));
                } else {
                    setSelectedChars([...selectedChars, key]);
                }
            };

            const changeSelectedCharsSize = (newSize) => {
                if (selectedChars.length === 0) return;
                const newBlocks = blocks.map(block => {
                    if (block.type === 'lyric') {
                        const newCharSizes = [...block.charSizes];
                        selectedChars.forEach(key => {
                            const [blockId, charIdx] = key.split('-');
                            if (parseInt(blockId) === block.id) {
                                newCharSizes[parseInt(charIdx)] = newSize;
                            }
                        });
                        return { ...block, charSizes: newCharSizes };
                    }
                    return block;
                });
                setBlocks(newBlocks);
                setSelectedChars([]);
            };

            const getKeyDisplay = () => {
                return keyType === 'minor' ? `${songKey}m` : songKey;
            };

            return (
                <div>
                    <div className="header">
                        <h1>üé∏ „Éñ„É≠„ÉÉ„ÇØÂºè„Ç≥„Éº„ÉâË≠ú v3</h1>
                        <div style={{ fontSize: '13px', marginTop: '4px', opacity: 0.9 }}>
                            {blocks.length}ÂÄã„ÅÆ„Éñ„É≠„ÉÉ„ÇØ | Key: {getKeyDisplay()}
                        </div>
                    </div>

                    <div className="container">
                        <div className="card">
                            <div className="card-title">Êõ≤„ÅÆ„Ç≠„Éº</div>
                            <div className="key-selector">
                                <div className="key-note">
                                    <select value={songKey} onChange={(e) => setSongKey(e.target.value)} className="select">
                                        {['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'].map(note => (
                                            <option key={note} value={note}>{note}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="key-type">
                                    <button className={`key-type-btn ${keyType === 'major' ? 'active' : ''}`} onClick={() => setKeyType('major')}>„É°„Ç∏„É£„Éº</button>
                                    <button className={`key-type-btn ${keyType === 'minor' ? 'active' : ''}`} onClick={() => setKeyType('minor')}>„Éû„Ç§„Éä„Éº</button>
                                </div>
                            </div>
                        </div>

                        <div className="card">
                            <div className="card-title">ÂÖ•Âäõ</div>
                            
                            <div className="tabs">
                                <button onClick={() => setActiveTab('url')} className={`tab ${activeTab === 'url' ? 'tab-url' : 'tab-inactive'}`}>üîó URL</button>
                                <button onClick={() => setActiveTab('lyric')} className={`tab ${activeTab === 'lyric' ? 'tab-lyric' : 'tab-inactive'}`}>üé§ Ê≠åË©û</button>
                                <button onClick={() => setActiveTab('chord')} className={`tab ${activeTab === 'chord' ? 'tab-chord' : 'tab-inactive'}`}>üéµ „Ç≥„Éº„Éâ</button>
                            </div>

                            {activeTab === 'url' ? (
                                <div>
                                    <div className="input-group">
                                        <label className="label">U-FRET„ÅÆURL</label>
                                        <div className="url-input-row">
                                            <input
                                                type="url"
                                                value={urlInput}
                                                onChange={(e) => setUrlInput(e.target.value)}
                                                onPaste={(e) => {
                                                    setTimeout(() => setUrlInput(e.target.value), 10);
                                                }}
                                                className="input"
                                                placeholder="https://www.ufret.jp/song.php?data=..."
                                                disabled={isLoading}
                                            />
                                            <button onClick={fetchFromUrl} className="btn btn-purple" disabled={isLoading}>
                                                {isLoading ? 'Ë™≠Ëæº‰∏≠' : 'Ë™≠„ÅøËæº„ÇÄ'}
                                            </button>
                                        </div>
                                        <div className="hint">
                                            üí° U-FRET„ÅÆURL„ÇíË≤º„Çä‰ªò„Åë„Å¶„ÄåË™≠„ÅøËæº„ÇÄ„Äç„Éú„Çø„É≥„Çí„Çø„ÉÉ„Éó
                                        </div>
                                    </div>

                                    {isLoading && (
                                        <div className="loading">
                                            <div className="spinner"></div>
                                            <span>Ë™≠„ÅøËæº„Åø‰∏≠...</span>
                                        </div>
                                    )}

                                    {debugInfo && (
                                        <div className="debug-info">
                                            {debugInfo}
                                        </div>
                                    )}

                                    {loadError && (
                                        <div className="error-box">
                                            ‚ùå {loadError}
                                        </div>
                                    )}

                                    {importPreview.length > 0 && (
                                        <div className="import-preview">
                                            <div style={{ fontWeight: 'bold', marginBottom: '8px', color: '#065f46' }}>
                                                ‚úì „Éó„É¨„Éì„É•„ÉºÔºà{importPreview.length}Ë°åÔºâ
                                            </div>
                                            <div style={{ maxHeight: '200px', overflowY: 'auto', marginBottom: '12px' }}>
                                                {importPreview.slice(0, 30).map((item, idx) => (
                                                    <div key={idx} className={`import-preview-item ${item.type === 'chord' ? 'import-preview-chord' : 'import-preview-lyric'}`}>
                                                        {item.type === 'chord' ? 'üéµ' : 'üé§'} {item.content}
                                                    </div>
                                                ))}
                                                {importPreview.length > 30 && (
                                                    <div style={{ textAlign: 'center', color: '#6b7280', padding: '8px' }}>
                                                        ...‰ªñ {importPreview.length - 30}Ë°å
                                                    </div>
                                                )}
                                            </div>
                                            <button onClick={executeImport} className="btn btn-success">
                                                Âèñ„ÇäËæº„ÇÄ
                                            </button>
                                        </div>
                                    )}
                                </div>
                            ) : activeTab === 'lyric' ? (
                                <div>
                                    <div className="input-group">
                                        <label className="label">Ê≠åË©ûÔºàÊîπË°å„ÅßË§áÊï∞Ë°åÔºâ</label>
                                        <textarea value={lyricInput} onChange={(e) => setLyricInput(e.target.value)} className="textarea" placeholder="Ê≠åË©û„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ&#10;ÊîπË°å„ÅßË§áÊï∞Ë°åËøΩÂä†„Åß„Åç„Åæ„Åô"></textarea>
                                    </div>
                                    <div className="input-group">
                                        <label className="label">Âü∫Êú¨ÊñáÂ≠ó„Çµ„Ç§„Ç∫</label>
                                        <select value={lyricSize} onChange={(e) => setLyricSize(parseInt(e.target.value))} className="select">
                                            {[12, 14, 16, 18, 20, 22, 24, 28].map(size => (<option key={size} value={size}>{size}pt</option>))}
                                        </select>
                                    </div>
                                    <button onClick={addLyric} className="btn btn-warning">ËøΩÂä†</button>
                                </div>
                            ) : (
                                <div>
                                    {blocks.length === 0 ? (
                                        <div className="empty-state" style={{ padding: '20px' }}>
                                            <div style={{ fontSize: '16px', color: '#6b7280' }}>ÂÖà„Å´Ê≠åË©û„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                                        </div>
                                    ) : (
                                        <>
                                            <div className="insert-position">
                                                <label className="label">ÊåøÂÖ•‰ΩçÁΩÆ„ÇíÈÅ∏Êäû</label>
                                                <div className={`insert-position-item ${insertPosition?.type === 'before' && insertPosition?.index === 0 ? 'selected' : ''}`} onClick={() => setInsertPosition({ type: 'before', index: 0 })}>
                                                    <span>üìç ‰∏ÄÁï™ÊúÄÂàù</span>
                                                </div>
                                                {blocks.map((block, idx) => (
                                                    <div key={block.id} className={`insert-position-item ${insertPosition?.type === 'after' && insertPosition?.index === idx ? 'selected' : ''}`} onClick={() => setInsertPosition({ type: 'after', index: idx })}>
                                                        <span>{block.type === 'chord' ? 'üéµ' : 'üé§'} {block.content.substring(0, 20)}{block.content.length > 20 ? '...' : ''}</span>
                                                        <span style={{ color: '#6b7280', fontSize: '12px' }}>‚Üê „Åì„ÅÆÂæå</span>
                                                    </div>
                                                ))}
                                            </div>
                                            <div className="input-group">
                                                <label className="label">„Ç≥„Éº„ÉâÔºàÊîπË°å„ÅßË§áÊï∞Ë°åÔºâ</label>
                                                <textarea value={chordInput} onChange={(e) => setChordInput(e.target.value)} className="textarea" placeholder="C&#10;Am&#10;F&#10;G" style={{ minHeight: '100px' }}></textarea>
                                            </div>
                                            <div className="input-group">
                                                <label className="label">ÊñáÂ≠ó„Çµ„Ç§„Ç∫</label>
                                                <select value={chordSize} onChange={(e) => setChordSize(parseInt(e.target.value))} className="select">
                                                    {[12, 14, 16, 18, 20, 22, 24, 28, 32].map(size => (<option key={size} value={size}>{size}pt</option>))}
                                                </select>
                                            </div>
                                            <button onClick={addChord} className="btn btn-primary">ÈÅ∏Êäû‰ΩçÁΩÆ„Å´ËøΩÂä†</button>
                                        </>
                                    )}
                                </div>
                            )}
                        </div>

                        {selectedChars.length > 0 && (
                            <div className="card">
                                <div className="card-title">ÈÅ∏ÊäûÊñáÂ≠ó„ÅÆÊìç‰Ωú</div>
                                <div className="input-group">
                                    <div style={{ background: '#dbeafe', padding: '8px 12px', borderRadius: '8px', marginBottom: '8px', fontSize: '14px', fontWeight: '600' }}>
                                        {selectedChars.length}ÊñáÂ≠óÈÅ∏Êäû‰∏≠
                                    </div>
                                    <label className="label">ÊñáÂ≠ó„Çµ„Ç§„Ç∫Â§âÊõ¥</label>
                                    <select className="select" onChange={(e) => e.target.value && changeSelectedCharsSize(parseInt(e.target.value))} defaultValue="">
                                        <option value="">ÈÅ∏Êäû...</option>
                                        {[12, 14, 16, 18, 20, 22, 24, 28, 32].map(size => (<option key={size} value={size}>{size}pt</option>))}
                                    </select>
                                </div>
                            </div>
                        )}

                        <div className="card">
                            <div className="card-title">„Éñ„É≠„ÉÉ„ÇØ‰∏ÄË¶ß</div>
                            {selectedBlocks.length > 0 && (
                                <div className="selection-controls">
                                    <div style={{ fontSize: '14px', fontWeight: '600', marginBottom: '8px' }}>{selectedBlocks.length}ÂÄãÈÅ∏Êäû‰∏≠</div>
                                    <div style={{ display: 'flex', gap: '8px' }}>
                                        <button onClick={moveSelectedBlocksUp} className="btn btn-small btn-primary">‚Üë ‰∏ä„Å∏</button>
                                        <button onClick={moveSelectedBlocksDown} className="btn btn-small btn-primary">‚Üì ‰∏ã„Å∏</button>
                                        <button onClick={deleteSelectedBlocks} className="btn btn-small btn-danger">ÂâäÈô§</button>
                                        <button onClick={() => setSelectedBlocks([])} className="btn btn-small" style={{ background: '#e5e7eb' }}>Ëß£Èô§</button>
                                    </div>
                                </div>
                            )}
                            {blocks.length === 0 ? (
                                <div className="empty-state">
                                    <div style={{ fontSize: '48px', marginBottom: '12px' }}>üé∏</div>
                                    <div>URL„Åã„ÇâË™≠„ÅøËæº„ÇÄ„ÅãÊ≠åË©û„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                                </div>
                            ) : (
                                <div>
                                    <div style={{ marginBottom: '12px' }}>
                                        <button onClick={toggleSelectAll} className="btn btn-small" style={{ background: '#e5e7eb' }}>
                                            {selectedBlocks.length === blocks.length ? 'ÂÖ®Ëß£Èô§' : 'ÂÖ®ÈÅ∏Êäû'}
                                        </button>
                                    </div>
                                    {blocks.map((block) => (
                                        <div key={block.id} className={`block-item ${block.type === 'chord' ? 'block-chord' : 'block-lyric'}`}>
                                            <input type="checkbox" className="block-checkbox" checked={selectedBlocks.includes(block.id)} onChange={() => toggleBlockSelection(block.id)} />
                                            <div className="block-content">
                                                <div className="block-header">
                                                    <div className="block-type">
                                                        <span>{block.type === 'chord' ? 'üéµ' : 'üé§'}</span>
                                                        <span>{block.type === 'chord' ? '„Ç≥„Éº„Éâ' : 'Ê≠åË©û'}</span>
                                                        <span className="badge">{block.fontSize}pt</span>
                                                    </div>
                                                    <div className="block-controls">
                                                        <button onClick={() => deleteBlock(block.id)} className="icon-btn icon-btn-danger">√ó</button>
                                                    </div>
                                                </div>
                                                <div>
                                                    {block.type === 'chord' ? (
                                                        <div style={{ fontSize: `${block.fontSize}px`, fontWeight: 'bold', color: '#3b82f6' }}>{block.content}</div>
                                                    ) : (
                                                        <div>
                                                            {block.content.split('').map((char, charIdx) => (
                                                                <span key={charIdx} className={`char-box ${selectedChars.includes(`${block.id}-${charIdx}`) ? 'selected' : ''}`} style={{ fontSize: `${block.charSizes[charIdx]}px` }} onClick={() => toggleCharSelection(block.id, charIdx)}>{char}</span>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {blocks.length > 0 && (
                            <div className="card">
                                <div className="card-title">„Éó„É¨„Éì„É•„Éº</div>
                                <div style={{ marginBottom: '8px', fontSize: '14px', fontWeight: '600', color: '#6b7280' }}>Key: {getKeyDisplay()}</div>
                                <div className="preview">
                                    {blocks.map((block) => (
                                        <div key={block.id}>
                                            {block.type === 'chord' ? (
                                                <div className="preview-chord" style={{ fontSize: `${block.fontSize}px` }}>{block.content}</div>
                                            ) : (
                                                <div className="preview-lyric">{block.content.split('').map((char, charIdx) => (<span key={charIdx} style={{ fontSize: `${block.charSizes[charIdx]}px` }}>{char}</span>))}</div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        <div className="card" style={{ background: '#fffbeb', border: '2px solid #fbbf24' }}>
                            <div className="card-title" style={{ color: '#92400e' }}>üí° ‰Ωø„ÅÑÊñπ</div>
                            <div style={{ fontSize: '14px', color: '#78350f', lineHeight: '1.8' }}>
                                <p><strong>1. URLË™≠„ÅøËæº„Åø:</strong> U-FRET„ÅÆURL„ÇíË≤º„Çä‰ªò„Åë„Å¶Ëá™ÂãïÂèñ„ÇäËæº„Åø</p>
                                <p><strong>2. ÊâãÂãïÂÖ•Âäõ:</strong> Ê≠åË©û‚Üí„Ç≥„Éº„Éâ„ÅÆÈ†Ü„ÅßÂÖ•Âäõ</p>
                                <p><strong>3. Ë§áÊï∞ÈÅ∏Êäû:</strong> „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Åß„Åæ„Å®„ÇÅ„Å¶ÁßªÂãï</p>
                                <p><strong>4. ÊñáÂ≠óË™øÊï¥:</strong> Ê≠åË©û„ÅÆÊñáÂ≠ó„Çí„Çø„ÉÉ„Éó„Åó„Å¶„Çµ„Ç§„Ç∫Â§âÊõ¥</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<BlockEditor />, document.getElementById('root'));
    </script>
</body>
</html>
